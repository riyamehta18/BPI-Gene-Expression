---
title: "QBS103 Final Project"
output:
  html_document: default
  pdf_document: default
date: "2023-07-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggthemes)
library(ggpubr)
library(gridExtra)
library(dplyr)
library(ggtext)
```

```{r}
metadata <- read.csv("QBS103_finalProject_metadata.csv", row.names = 1)
gene_exp <- read.csv("QBS103_finalProject_geneExpression.csv", row.names = 1)
```


```{r}
#chosen gene: BPI - bactericidal permeability increasing protein - Plays a role in the immune response against bacterial infections, can kill the bacterial by targeting their cell membrane and can also increase permeability of cell membranes, encodes a lipopolysaccharide binding protein and helps with regulating inflammatory responses - information from https://www.ncbi.nlm.nih.gov/gene/671#summary

BPI <- gene_exp["BPI",]
BPI <- as.data.frame(t(BPI)) #transposes the matrix
metadata_BPI <- cbind(metadata, BPI) #creates one data frame with all BPI data
suppressWarnings(metadata_BPI$age <- as.integer(metadata_BPI$age))

```

```{r}
#creates histogram of BPI

ggplot(metadata_BPI, aes(x = BPI)) + geom_histogram(color = "#6794a7", fill = "white", bins = 50) + 
  labs(x = "Gene Expression Levels of BPI", y = "Total Number of Samples", title = "Distribution of Gene Expression Levels for BPI") + 
  theme_economist() + 
  scale_fill_economist() + 
  theme(plot.title = element_text(size=15, face="bold", margin = margin(10, 0, 10, 0), hjust = (0.5)), axis.title.x = element_text(vjust=-0.40), axis.title.y= element_text(vjust=2 ))

# interpretation - shows the distribution of BPI gene expression in the samples. there are more studies with lower gene expression levels of BPI with a smaller amount of samples showing higher levels of expression levels. the majority of samples are seen below the threshold of 200.
```

```{r}
#chosen continuous covariate: age

#creates scatterplot with BPI and age
suppressWarnings(scatter_outliers <- ggplot(metadata_BPI, aes(x = BPI, y = age)) + 
  geom_point(color = "#6794a7", fill = "white") + 
  labs(x = "Gene Expression Levels of BPI", y = "Age") + 
  theme_economist() + 
  scale_fill_economist() + 
  theme(plot.title = element_text(size=12, face="bold", margin = margin(10, 0, 10, 0)), axis.title.x = element_text(vjust=-0.40), axis.title.y= element_text(vjust=2)))

#creates scatterplot with BPI and age and sets x-axis range from 0 to 150 for easier viewing
suppressWarnings(scatter_no_outliers <- ggplot(metadata_BPI, aes(x = BPI, y = age)) + 
  geom_point(color = "#6794a7", fill = "white") + 
  labs(x = "Gene Expression Levels of BPI", y = "Age") + 
  theme_economist() + 
  scale_fill_economist() + 
  theme(plot.title = element_text(size=12, face="bold", margin = margin(10, 0, 10, 0)), axis.title.x = element_text(vjust=-0.40), axis.title.y= element_text(vjust=2)) + 
  xlim(0, 150))

#creates scatterplot of both previous plots combined
suppressWarnings(new_scatter <- ggarrange(scatter_outliers, scatter_no_outliers,ncol=2, labels = c("A: Outliers Included", "B: Outliers Excluded"))) 

#adds title to the combined plot
suppressWarnings(annotate_figure(new_scatter, top = text_grob("Age vs. Gene Expression Levels of BPI", color = "#6794a7", face = "bold", size = 14)))

#interpretation - shows the relationship between BPI gene expression and ages of individuals sampled. there is not necessarily a clear relationship that can be observed in this graph without further analysis. the points seem to be clustered towards the lower gene expression levels around ages 50-85.
```

```{r}
#chosen categorical covariates: sex and mechanical ventilation

#create new dataset with the row of data where sex = "unknown"
unknown_removed <- metadata_BPI
unknown_removed <- metadata_BPI[metadata_BPI$sex != " unknown", ]

#creates scatterplot with BPI, sex, and mechanical ventilation
suppressWarnings(box_outliers <- ggplot(unknown_removed,aes(x = sex,y = BPI, color = mechanical_ventilation)) + geom_boxplot() + scale_x_discrete(labels = c("Female", "Male")) + labs(x = "Sex", y = "Gene Expression Levels of BPI", color = "Mechanical Ventilation") + theme_economist() + scale_color_manual(values = c('#014d64','#6794a7')) + theme(plot.title = element_text(size=15, face="bold", margin = margin(10, 0, 10, 0), hjust = (0.5)), axis.title.x = element_text(vjust=-0.40), axis.title.y= element_text(vjust=2))) 

#creates scatterplot with BPI, sex, and mechanical ventilation and sets y-axis range from 0 to 200 for easier viewing
suppressWarnings(box_no_outliers <- ggplot(unknown_removed,aes(x = sex,y = BPI, color = mechanical_ventilation)) + geom_boxplot() + scale_x_discrete(labels = c("Female", "Male")) + labs(x = "Sex", y = "Gene Expression Levels of BPI", color = "Mechanical Ventilation") + theme_economist() + scale_color_manual(values = c('#014d64','#6794a7')) + theme(plot.title = element_text(size=15, face="bold", margin = margin(10, 0, 10, 0), hjust = (0.5)), axis.title.x = element_text(vjust=-0.40), axis.title.y= element_text(vjust=2)) + ylim(0, 200))

#creates boxplot of both previous plots combined
suppressWarnings(new_box <- ggarrange(box_outliers, box_no_outliers,ncol=2, labels = c("A: Outliers Included", "B: Outliers Excluded")))

#adds title to the combined plot
annotate_figure(new_box, top = text_grob("BPI Expression by Sex and Mechanical Ventilation", color = "#6794a7", face = "bold", size = 14))

#interpretation - shows distribution of BPI gene expression across sexes and ventilation categories. from the graph on the right, we can see that the samples with mechanical ventilation have a higher mean gene expression level. this is true for both males and females. the mechanical ventilation groups have a higher iqr when compared to the groups without mechanical ventilation. the females from the study seem to have a higher mean gene expression level than the males.
```

```{r}
#Code for boxplot, scatter, and histogram
all_graphs <- function(data, genes, gene_exp, contcovariate, catcovariate1, catcovariate2, metadata) { #takes in input of data, names of genes, all covariates
  graphs <- list()
  for (gene in genes) { #creates a loop to create each graph per gene
    gene_data <- as.numeric(t(gene_exp[gene, ]))
    metadata_gene <- cbind(metadata, gene_data)
    
    #relabels data within a few covariates for better keys in boxplots
    metadata_gene$icu_status <- ifelse(metadata_gene$icu_status == " yes", "in icu", "not in icu")
    metadata_gene$mechanical_ventilation <- ifelse(metadata_gene$mechanical_ventilation == " yes", "on mechanical ventilation", "not on mechanical ventilation")
    metadata_gene$disease_status <- ifelse(metadata_gene$disease_status == "disease state: COVID-19", "COVID-19", "not COVID-19")
    
    
    #creates histogram
    hist <- ggplot(metadata_gene, aes(x = gene_data)) +
      geom_histogram(color = "#76c0c1", fill = "white", bins = 50) + 
      labs(x = substitute(paste("Gene Expression Levels of ", italic(gene)), list(gene = gene)), #substitute done to use italics
           y = "Total Number of Samples", 
           title = substitute(paste("Distribution of Gene Expression Levels for ", italic(gene)), list(gene = gene))) +
      theme_economist() + 
      scale_fill_economist() + 
      theme(plot.title = element_text(size = 15, face = "bold", margin = margin(10, 0, 10, 0), hjust = 0.5),
            axis.title.x = element_text(vjust = -0.4),
            axis.title.y = element_text(vjust = 2))
    
    
    #creates scatter plot
    metadata_gene$contcovariate <- as.integer(metadata_gene[[contcovariate]])
    metadata_gene <- metadata_gene[!is.na(metadata_gene$contcovariate), ]

    scatter <- ggplot(metadata_gene, aes(x = contcovariate, y = gene_data)) + 
      geom_point(color = "#76c0c1", fill = "white") + 
      labs(x = paste("", contcovariate) , y = substitute(paste("Gene Expression Levels of ", italic(gene)), list(gene = gene))) +
      theme_economist() + 
      scale_fill_economist() + 
      theme(plot.title = element_text(size = 15, face = "bold", margin = margin(10, 0, 10, 0), hjust = 0.5), axis.title.x = element_text(vjust=-0.40), axis.title.y = element_text(vjust = 2)) + scale_x_continuous(breaks = seq(0, 100, by = 10)) + scale_y_continuous(breaks = seq(0, 500, by = 50)) + 
      ggtitle(substitute(paste("Gene Expression Levels of ", italic(gene), " vs. ", contcovariate), list(gene = gene, contcovariate = contcovariate)))

    
    #creates boxplot
    metadata_gene$catcovariate1 <- as.factor(metadata_gene[[catcovariate1]])
    metadata_gene$catcovariate2 <- as.factor(metadata_gene[[catcovariate2]])
    metadata_gene <- metadata_gene[!is.na(metadata_gene$catcovariate1) & !is.na(metadata_gene$catcovariate2) & (metadata_gene$catcovariate1 != " unknown") * (metadata_gene$catcovariate2 != " unknown"), ]

    box <- ggplot(metadata_gene, aes(x = catcovariate1, y = gene_data, color = catcovariate2)) + 
      geom_boxplot() + 
      scale_x_discrete(labels = levels(metadata_gene$catcovariate1)) + 
      labs(x = gsub("_", " ", paste("", catcovariate1)), y = substitute(paste("Gene Expression Levels of ", italic(gene)), list(gene = gene)), color = gsub("_", " ", paste("", catcovariate2))) +
      theme_economist() + 
      scale_color_manual(values = c('#014d64','#76c0c1')) + 
      theme(plot.title = element_text(size = 15, face ="bold", margin = margin(10, 0, 10, 0), hjust = (0.5)), axis.title.x = element_text(vjust=-0.40), axis.title.y = element_text(vjust=2)) +
      ggtitle(substitute(paste(italic(gene), " Expression by ", catcovariate1, " and ", "_", " ", catcovariate2), list(gene = gene, catcovariate1 = catcovariate1, catcovariate2 = catcovariate2)))
    
    plots <- list(hist = hist, scatter = scatter, box = box)
    graphs[[gene]] <- plots
    
  }
  return(graphs)
}
  
selected_genes <- c("BPI", "MPO")

multiple_graphs <- all_graphs(data = gene_exp, genes = selected_genes, contcovariate = "age", catcovariate1 = "mechanical_ventilation", catcovariate2 = "disease_status", gene_exp = gene_exp, metadata = metadata)

for (gene in selected_genes) {
  print(multiple_graphs[[gene]]$hist)
  print(multiple_graphs[[gene]]$scatter)
  print(multiple_graphs[[gene]]$box)
}

```

```{r}
#calling the function
additional_genes <- c("GPLD1", "AAK1")
selected_genes <- c("BPI", "MPO", "GPLD1", "AAK1")
multiple_graphs <- all_graphs(data = gene_exp, genes = selected_genes, contcovariate = "age", catcovariate1 = "sex", catcovariate2 = "mechanical_ventilation", gene_exp = gene_exp, metadata = metadata)
print(multiple_graphs)
```